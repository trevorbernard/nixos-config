#!/usr/bin/env bash

set -x
set -euo pipefail

# Replace with your actual target server
TARGET='root@YOUR_SERVER_IP'

# Check if BUILDKITE_AGENT_TOKEN is set
if [ -z "${BUILDKITE_AGENT_TOKEN:-}" ]; then
    echo "Error: BUILDKITE_AGENT_TOKEN environment variable is not set"
    echo "Usage: BUILDKITE_AGENT_TOKEN=your_token_here ./deploy"
    exit 1
fi

# Deploy configuration and set up secure token
scp *.nix "$TARGET":
ssh "$TARGET" "
  systemctl stop buildkite-agent.service || true
  mkdir -p /run/keys &&
  echo '${BUILDKITE_AGENT_TOKEN}' > /run/keys/buildkite-agent-token &&
  nixos-rebuild switch -I nixos-config=config.nix &&
  chown bk:keys /run/keys/buildkite-agent-token &&
  chmod 0400 /run/keys/buildkite-agent-token &&
  nixos-rebuild boot -I nixos-config=config.nix &&
  systemctl start buildkite-agent.service
  :
"